<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Directory - Finch Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .btn-purple {
            background-color: #6f42c1;
            color: white;
        }

        .btn-purple:hover {
            background-color: #5a32a3;
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .content-header {
            padding: 24px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .tabs {
            display: flex;
            gap: 0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: #28a745;
            border-bottom-color: #28a745;
        }

        .search-container {
            position: relative;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #28a745;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 16px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        .employee-table {
            width: 100%;
            border-collapse: collapse;
        }

        .employee-table th {
            background-color: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }

        .employee-table td {
            padding: 16px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .employee-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .employee-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .employee-row.inactive {
            opacity: 0.6;
        }

        /* Employee Info */
        .employee-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .employee-details h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .employee-details p {
            margin: 0;
            font-size: 13px;
            color: #6c757d;
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Unavailable text */
        .unavailable {
            color: #6c757d;
            font-style: italic;
            font-size: 13px;
        }


        /* Error Message */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin: 24px;
            border: 1px solid #f5c6cb;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #495057;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-buttons {
                justify-content: center;
            }

            .content-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                min-width: auto;
            }

            .employee-table th,
            .employee-table td {
                padding: 12px 8px;
                font-size: 13px;
            }

            .employee-info {
                gap: 8px;
            }

            .employee-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }

        /* Company Card Styles */
        .company-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .company-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .company-main-info {
            flex: 1;
        }

        .company-name {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 8px 0;
        }

        .company-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .company-ein,
        .company-contact {
            font-size: 14px;
            color: #6c757d;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .company-error {
            color: #dc3545;
            font-style: italic;
            font-size: 14px;
        }

        .company-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            min-width: 60px;
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: 600;
            color: #28a745;
            line-height: 1;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }


        .company-details {
            border-top: 1px solid #e9ecef;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .detail-section h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 4px;
        }

        .detail-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-item strong {
            color: #495057;
            min-width: 100px;
            display: inline-block;
        }

        .detail-item span {
            color: #6c757d;
        }

        .department-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .department-tag {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .location-item {
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive updates for company card */
        @media (max-width: 768px) {
            .company-header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .company-stats {
                justify-content: center;
                gap: 16px;
            }

            .details-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .company-meta {
                justify-content: center;
            }
        }

        /* Employee Drawer Styles */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .employee-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 520px;
            height: 100%;
            background: #ffffff;
            box-shadow: -8px 0 32px rgba(0, 0, 0, 0.12);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            overflow-y: auto;
            border-radius: 16px 0 0 16px;
        }

        .employee-drawer.active {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 0;
            border-bottom: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: sticky;
            top: 0;
            z-index: 10;
            border-radius: 16px 0 0 0;
        }

        .drawer-header-content {
            padding: 32px 24px 24px;
            position: relative;
        }

        .drawer-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .drawer-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .employee-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            color: white;
        }

        .employee-profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .employee-profile-info h2 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: white;
        }

        .employee-profile-info .employee-id {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .employee-status-badges {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .status-badge-modern {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .status-badge-active {
            background: rgba(34, 197, 94, 0.2);
            color: #10b981;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .status-badge-inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .drawer-content {
            padding: 0;
            background: #f8fafc;
        }

        .drawer-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 24px;
            position: sticky;
            top: 140px;
            z-index: 5;
        }

        .drawer-tab {
            padding: 16px 20px;
            background: none;
            border: none;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            font-size: 14px;
        }

        .drawer-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
        }

        .drawer-tab:hover:not(.active) {
            color: #475569;
            background: #f8fafc;
        }

        .drawer-tab-content {
            padding: 24px;
        }

        .info-cards {
            display: grid;
            gap: 16px;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .info-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .info-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .info-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .info-card-icon.personal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .info-card-icon.contact {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .info-card-icon.employment {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .info-card-icon.location {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .info-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        .info-value.unavailable {
            color: #94a3b8;
            font-style: italic;
            font-weight: 400;
        }

        .drawer-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            flex-direction: column;
            gap: 20px;
            background: #f8fafc;
        }

        .drawer-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .drawer-loading-text {
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
        }

        .drawer-error {
            background: #fef2f2;
            color: #dc2626;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #fecaca;
            margin: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .drawer-error-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #dc2626;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Make table rows clickable */
        .employee-row {
            cursor: pointer;
        }

        .employee-row:hover {
            background-color: #f8f9fa !important;
        }

        /* Responsive drawer */
        @media (max-width: 768px) {
            .employee-drawer {
                width: 100%;
                right: 0;
            }
        }

        /* Copy to clipboard styles */
        .copy-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: 8px;
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid rgba(0, 123, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #007bff;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .copy-button:hover {
            opacity: 1;
            background: rgba(0, 123, 255, 0.2);
            transform: scale(1.1);
        }

        .copy-button.copied {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.3);
            color: #28a745;
        }

        .copy-id-container {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .copy-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .copy-feedback.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Deductions Styles */
        .deductions-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 20px;
            color: #6c757d;
        }

        .deductions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 24px;
        }

        .benefit-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .benefit-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .benefit-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .benefit-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .benefit-icon.retirement {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .benefit-icon.health {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .benefit-icon.commuter {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .benefit-icon.custom {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .benefit-icon.default {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .benefit-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 4px 0;
        }

        .benefit-type {
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .benefit-description {
            color: #495057;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .benefit-details {
            display: grid;
            gap: 12px;
        }

        .benefit-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .benefit-detail-item:last-child {
            border-bottom: none;
        }

        .benefit-detail-label {
            font-size: 13px;
            font-weight: 500;
            color: #6c757d;
        }

        .benefit-detail-value {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
        }

        .frequency-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .frequency-every-paycheck {
            background-color: #d4edda;
            color: #155724;
        }

        .frequency-monthly {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .frequency-one-time {
            background-color: #f8d7da;
            color: #721c24;
        }

        .company-contribution {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .contribution-header {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .contribution-tier {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }

        .contribution-tier:not(:last-child) {
            border-bottom: 1px solid #e9ecef;
        }

        .tier-threshold {
            color: #6c757d;
        }

        .tier-match {
            color: #28a745;
            font-weight: 500;
        }

        .deductions-search {
            padding: 24px 24px 0;
        }

        .deductions-search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }

        .deductions-search-input:focus {
            outline: none;
            border-color: #28a745;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .deductions-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 16px;
        }

        .deductions-summary {
            padding: 24px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-stats {
            display: flex;
            gap: 32px;
            justify-content: center;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat-number {
            display: block;
            font-size: 24px;
            font-weight: 600;
            color: #28a745;
            line-height: 1;
        }

        .summary-stat-label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Tab content styles */
        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .deductions-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .summary-stats {
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Employee Directory</h1>
            <div class="nav-buttons">
                <a href="/" class="btn btn-secondary">← Back to Provider Selection</a>
            </div>
        </div>

        <!-- Company Info Card -->
        {% if company_data or company_error %}
        <div class="company-card">
            <div class="company-header">
                <div class="company-main-info">
                    {% if company_data %}
                        <h2 class="company-name">{{ company_data.legal_name or 'Company Name Unavailable' }}</h2>
                        <div class="company-meta">
                            {% if company_data.ein %}
                                <span class="company-ein">EIN: {{ company_data.ein }}</span>
                            {% endif %}
                            {% if company_data.primary_email %}
                                <span class="company-contact">{{ company_data.primary_email }}</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <h2 class="company-name">Company Information</h2>
                        <div class="company-error">{{ company_error }}</div>
                    {% endif %}
                </div>
                <div class="company-stats">
                    {% if company_data %}
                        {% if company_data.departments %}
                            <div class="stat-item">
                                <span class="stat-number">{{ company_data.departments|length }}</span>
                                <span class="stat-label">Departments</span>
                            </div>
                        {% endif %}
                        {% if company_data.locations %}
                            <div class="stat-item">
                                <span class="stat-number">{{ company_data.locations|length }}</span>
                                <span class="stat-label">Locations</span>
                            </div>
                        {% endif %}
                        {% if directory_data %}
                            <div class="stat-item">
                                <span class="stat-number">{{ directory_data|length }}</span>
                                <span class="stat-label">Employees</span>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            {% if company_data %}
            <div class="company-details">
                <div class="details-grid">
                    <div class="detail-section">
                        <h4>Contact Information</h4>
                        <div class="detail-item">
                            <strong>Email:</strong> 
                            <span>{{ company_data.primary_email or 'Not available' }}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Phone:</strong> 
                            <span>{{ company_data.primary_phone_number or 'Not available' }}</span>
                        </div>
                        {% if company_data.entity %}
                        <div class="detail-item">
                            <strong>Entity Type:</strong> 
                            <span>{{ company_data.entity.type or 'Not available' }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if company_data.departments %}
                    <div class="detail-section">
                        <h4>Departments</h4>
                        <div class="department-list">
                            {% for department in company_data.departments %}
                                <span class="department-tag">{{ department.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if company_data.locations %}
                    <div class="detail-section">
                        <h4>Locations</h4>
                        {% for location in company_data.locations %}
                        <div class="location-item">
                            {% if location.name %}<strong>{{ location.name }}</strong><br>{% endif %}
                            {{ location.line1 or '' }}{% if location.line2 %}, {{ location.line2 }}{% endif %}<br>
                            {{ location.city or '' }}{% if location.state %}, {{ location.state }}{% endif %} {{ location.postal_code or '' }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Main Content -->
        <div class="main-content">
        <div class="content-header">
            <div class="tabs">
                <button class="tab active" data-tab="employees">Employee List</button>
                <button class="tab" data-tab="deductions">Deductions</button>
            </div>
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-input" placeholder="Search by name, department, or employee ID..." id="searchInput">
            </div>
        </div>

            <!-- Employee List Tab Content -->
            <div id="employeesTabContent" class="tab-content">
                {% if directory_error %}
                    <div class="error-message">
                        <strong>Error:</strong> {{ directory_error }}
                    </div>
                {% elif directory_data %}
                    <div class="table-container">
                        <table class="employee-table" id="employeeTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Manager</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in directory_data %}
                                <tr class="employee-row {{ 'inactive' if not employee.is_active else '' }}" data-name="{{ (employee.first_name + ' ' + employee.last_name).lower() }}" data-department="{{ employee.department.name.lower() if employee.department else '' }}" data-employee-id="{{ employee.id }}" onclick="openEmployeeDrawer('{{ employee.id }}')">
                                    <td>
                                        <div class="employee-info">
                                            <div class="employee-avatar">
                                                {{ employee.first_name[0] if employee.first_name else '?' }}{{ employee.last_name[0] if employee.last_name else '' }}
                                            </div>
                                            <div class="employee-details">
                                                <h4>{{ employee.first_name }} {% if employee.middle_name %}{{ employee.middle_name[0] }}. {% endif %}{{ employee.last_name }}</h4>
                                                <p class="copy-id-container">ID: {{ employee.id }}<button class="copy-button" onclick="event.stopPropagation(); copyToClipboard('{{ employee.id }}', this)" title="Copy Employee ID" aria-label="Copy Employee ID">📋</button></p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if employee.department %}
                                            <span>{{ employee.department.name }}</span>
                                        {% else %}
                                            <span class="unavailable">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if employee.manager %}
                                            <span>{{ employee.manager.id }}</span>
                                        {% else %}
                                            <span class="unavailable">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="status-badge {{ 'status-active' if employee.is_active else 'status-inactive' }}">
                                            {{ 'Active' if employee.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <h3>No employees found</h3>
                        <p>There are no employees in the directory at this time.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Deductions Tab Content -->
            <div id="deductionsTabContent" class="tab-content" style="display: none;">
                <div class="deductions-loading">
                    <div class="loading"></div>
                    <p>Loading deductions data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Details Drawer -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeEmployeeDrawer()"></div>
    <div class="employee-drawer" id="employeeDrawer">
        <div class="drawer-header">
            <div class="drawer-header-content">
                <button class="drawer-close" onclick="closeEmployeeDrawer()" aria-label="Close drawer">×</button>
                <div class="employee-profile" id="employeeProfile">
                    <div class="employee-profile-avatar" id="profileAvatar">?</div>
                    <div class="employee-profile-info">
                        <h2 id="profileName">Employee Details</h2>
                        <p class="employee-id" id="profileId">Loading...</p>
                    </div>
                </div>
                <div class="employee-status-badges" id="statusBadges">
                    <!-- Status badges will be populated by JavaScript -->
                </div>
            </div>
        </div>
        <div class="drawer-tabs" id="drawerTabs">
            <button class="drawer-tab active" data-tab="overview">Overview</button>
            <button class="drawer-tab" data-tab="employment">Employment</button>
            <button class="drawer-tab" data-tab="payments">Payments</button>
        </div>
        <div class="drawer-content" id="drawerContent">
            <div class="drawer-loading">
                <div class="drawer-loading-spinner"></div>
                <p class="drawer-loading-text">Loading employee details...</p>
            </div>
        </div>
    </div>

    <script>
        let currentEmployeeData = null;
        let activeTab = 'overview';

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.employee-row');
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const department = row.getAttribute('data-department');
                const employeeId = row.getAttribute('data-employee-id').toLowerCase();
                const isVisible = name.includes(searchTerm) || department.includes(searchTerm) || employeeId.includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
            });
        });

        // Tab functionality
        function initializeTabs() {
            const tabs = document.querySelectorAll('.drawer-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.drawer-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            activeTab = tabName;
            
            // Re-render content for the active tab
            if (currentEmployeeData) {
                renderTabContent(currentEmployeeData, tabName);
            }
        }

        // Employee drawer functionality
        function openEmployeeDrawer(employeeId) {
            const overlay = document.getElementById('drawerOverlay');
            const drawer = document.getElementById('employeeDrawer');
            const content = document.getElementById('drawerContent');
            
            // Reset to overview tab
            activeTab = 'overview';
            document.querySelectorAll('.drawer-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('[data-tab="overview"]').classList.add('active');
            
            // Show loading state
            content.innerHTML = `
                <div class="drawer-loading">
                    <div class="drawer-loading-spinner"></div>
                    <p class="drawer-loading-text">Loading employee details...</p>
                </div>
            `;
            
            // Reset profile header
            document.getElementById('profileAvatar').textContent = '?';
            document.getElementById('profileName').textContent = 'Employee Details';
            document.getElementById('profileId').textContent = 'Loading...';
            document.getElementById('statusBadges').innerHTML = '';
            
            // Show drawer
            overlay.classList.add('active');
            drawer.classList.add('active');
            
            // Initialize tabs
            initializeTabs();
            
            // Fetch employee data
            fetch(`/api/employee/${employeeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch employee data');
                    }
                    return response.json();
                })
                .then(data => {
                    currentEmployeeData = data;
                    updateProfileHeader(data);
                    renderTabContent(data, activeTab);
                })
                .catch(error => {
                    console.error('Error fetching employee data:', error);
                    content.innerHTML = `
                        <div class="drawer-error">
                            <div class="drawer-error-icon">!</div>
                            <div>
                                <strong>Error:</strong> Failed to load employee details. Please try again.
                            </div>
                        </div>
                    `;
                });
        }

        function closeEmployeeDrawer() {
            const overlay = document.getElementById('drawerOverlay');
            const drawer = document.getElementById('employeeDrawer');
            
            overlay.classList.remove('active');
            drawer.classList.remove('active');
            currentEmployeeData = null;
        }

        function updateProfileHeader(data) {
            const profileAvatar = document.getElementById('profileAvatar');
            const profileName = document.getElementById('profileName');
            const profileId = document.getElementById('profileId');
            const statusBadges = document.getElementById('statusBadges');
            
            if (data.individual && !data.individual_error) {
                const individual = data.individual;
                const firstName = individual.first_name || '';
                const lastName = individual.last_name || '';
                const fullName = `${firstName} ${lastName}`.trim();
                
                // Update avatar
                const initials = `${firstName.charAt(0) || '?'}${lastName.charAt(0) || ''}`;
                profileAvatar.textContent = initials;
                
                // Update name and ID
                profileName.textContent = fullName || 'Employee Details';
                const employeeId = individual.id || 'Unknown';
                profileId.innerHTML = `<span class="copy-id-container">ID: ${employeeId}${createCopyButton(employeeId, 'Copy Employee ID')}</span>`;
                
                // Update status badges
                let badgesHtml = '';
                
                // Employment status badge
                if (data.employment && !data.employment_error) {
                    const isActive = data.employment.is_active;
                    if (isActive !== null && isActive !== undefined) {
                        const statusClass = isActive ? 'status-badge-active' : 'status-badge-inactive';
                        const statusText = isActive ? 'Active' : 'Inactive';
                        badgesHtml += `<span class="status-badge-modern ${statusClass}">${statusText}</span>`;
                    }
                }
                
                // Department badge
                if (data.employment && data.employment.department && data.employment.department.name) {
                    badgesHtml += `<span class="status-badge-modern" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-color: rgba(59, 130, 246, 0.3);">${data.employment.department.name}</span>`;
                }
                
                statusBadges.innerHTML = badgesHtml;
            }
        }

        function renderTabContent(data, tabName) {
            const content = document.getElementById('drawerContent');
            
            if (tabName === 'overview') {
                content.innerHTML = `
                    <div class="drawer-tab-content">
                        ${renderOverviewTab(data)}
                    </div>
                `;
            } else if (tabName === 'employment') {
                content.innerHTML = `
                    <div class="drawer-tab-content">
                        ${renderEmploymentTab(data)}
                    </div>
                `;
            } else if (tabName === 'payments') {
                // Show loading state for payments
                content.innerHTML = `
                    <div class="drawer-loading">
                        <div class="drawer-loading-spinner"></div>
                        <p class="drawer-loading-text">Loading payment data...</p>
                    </div>
                `;
                
                // Fetch payment data
                const employeeId = data.individual ? data.individual.id : null;
                if (employeeId) {
                    fetch(`/api/employee/${employeeId}/payments`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch payment data');
                            }
                            return response.json();
                        })
                        .then(paymentData => {
                            content.innerHTML = `
                                <div class="drawer-tab-content">
                                    ${renderPaymentsTab(paymentData)}
                                </div>
                            `;
                        })
                        .catch(error => {
                            console.error('Error fetching payment data:', error);
                            content.innerHTML = `
                                <div class="drawer-error">
                                    <div class="drawer-error-icon">!</div>
                                    <div>
                                        <strong>Error:</strong> Failed to load payment data. ${error.message}
                                    </div>
                                </div>
                            `;
                        });
                } else {
                    content.innerHTML = `
                        <div class="drawer-error">
                            <div class="drawer-error-icon">!</div>
                            <div>
                                <strong>Error:</strong> No employee ID available for payment lookup.
                            </div>
                        </div>
                    `;
                }
            }
        }

        function renderOverviewTab(data) {
            let html = '<div class="info-cards">';
            
            // Personal Information Card
            html += `
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon personal">👤</div>
                        <h3 class="info-card-title">Personal Information</h3>
                    </div>
                    <div class="info-grid">
            `;
            
            if (data.individual_error) {
                html += `<div class="drawer-error">
                    <div class="drawer-error-icon">!</div>
                    <div>${data.individual_error}</div>
                </div>`;
            } else if (data.individual) {
                const individual = data.individual;
                html += createInfoItem('First Name', individual.first_name);
                html += createInfoItem('Last Name', individual.last_name);
                html += createInfoItem('Preferred Name', individual.preferred_name);
                html += createInfoItem('Gender', individual.gender);
                html += createInfoItem('Date of Birth', individual.dob);
                html += createInfoItem('Ethnicity', individual.ethnicity);
            } else {
                html += '<p class="info-value unavailable">Personal information not available.</p>';
            }
            
            html += '</div></div>';
            
            // Contact Information Card
            html += `
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon contact">📧</div>
                        <h3 class="info-card-title">Contact Information</h3>
                    </div>
                    <div class="info-grid">
            `;
            
            if (data.individual && !data.individual_error) {
                const individual = data.individual;
                
                // Email
                const email = individual.emails && individual.emails[0] && individual.emails[0].data 
                    ? individual.emails[0].data : null;
                html += createInfoItem('Email', email);
                
                // Phone
                const phone = individual.phone_numbers && individual.phone_numbers[0] && individual.phone_numbers[0].data 
                    ? individual.phone_numbers[0].data : null;
                html += createInfoItem('Phone', phone);
            }
            
            html += '</div></div>';
            
            // Address Information Card
            if (data.individual && data.individual.residence) {
                html += `
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-icon location">📍</div>
                            <h3 class="info-card-title">Address</h3>
                        </div>
                        <div class="info-grid">
                `;
                
                const residence = data.individual.residence;
                html += createInfoItem('Street Address', residence.line1);
                if (residence.line2) {
                    html += createInfoItem('Address Line 2', residence.line2);
                }
                html += createInfoItem('City', residence.city);
                html += createInfoItem('State', residence.state);
                html += createInfoItem('Postal Code', residence.postal_code);
                html += createInfoItem('Country', residence.country);
                
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }

        function renderEmploymentTab(data) {
            let html = '<div class="info-cards">';
            
            // Employment Details Card
            html += `
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon employment">💼</div>
                        <h3 class="info-card-title">Employment Details</h3>
                    </div>
                    <div class="info-grid">
            `;
            
            if (data.employment_error) {
                html += `<div class="drawer-error">
                    <div class="drawer-error-icon">!</div>
                    <div>${data.employment_error}</div>
                </div>`;
            } else if (data.employment) {
                const employment = data.employment;
                
                html += createInfoItem('Job Title', employment.title);
                html += createInfoItem('Department', employment.department && employment.department.name ? employment.department.name : null);
                html += createInfoItem('Start Date', employment.start_date);
                html += createInfoItem('End Date', employment.end_date);
                
                const empType = employment.employment && employment.employment.type ? employment.employment.type : null;
                const empSubtype = employment.employment && employment.employment.subtype ? employment.employment.subtype : null;
                html += createInfoItem('Employment Type', empType);
                html += createInfoItem('Employment Subtype', empSubtype);
                
                const isActive = employment.is_active !== null && employment.is_active !== undefined 
                    ? (employment.is_active ? 'Yes' : 'No') : null;
                html += createInfoItem('Active Status', isActive);
                
                const manager = employment.manager && employment.manager.id ? employment.manager.id : null;
                html += createInfoItem('Manager ID', manager);
            } else {
                html += '<p class="info-value unavailable">Employment information not available.</p>';
            }
            
            html += '</div></div>';
            
            // Work Location Card
            if (data.employment && data.employment.location) {
                html += `
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-icon location">🏢</div>
                            <h3 class="info-card-title">Work Location</h3>
                        </div>
                        <div class="info-grid">
                `;
                
                const location = data.employment.location;
                html += createInfoItem('Address', location.line1);
                if (location.line2) {
                    html += createInfoItem('Address Line 2', location.line2);
                }
                html += createInfoItem('City', location.city);
                html += createInfoItem('State', location.state);
                html += createInfoItem('Postal Code', location.postal_code);
                html += createInfoItem('Country', location.country);
                
                html += '</div></div>';
            }
            
            // Compensation Card
            if (data.employment && (data.employment.income || (data.employment.income_history && data.employment.income_history.length > 0))) {
                html += `
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-card-icon employment">💰</div>
                            <h3 class="info-card-title">Compensation</h3>
                        </div>
                        <div class="info-grid">
                `;
                
                // Current income
                if (data.employment.income) {
                    const income = data.employment.income;
                    const amount = income.amount !== null && income.amount !== undefined ? income.amount : null;
                    const currency = income.currency || '';
                    const unit = income.unit || 'unit';
                    
                    const incomeText = amount !== null ? `${amount} ${currency} per ${unit}` : null;
                    html += createInfoItem('Current Income', incomeText);
                }
                
                html += '</div>';
                
                // Income history
                if (data.employment.income_history && data.employment.income_history.length > 0) {
                    html += '<div style="margin-top: 16px;">';
                    html += '<div class="info-label">Income History</div>';
                    html += '<div style="margin-top: 8px;">';
                    
                    data.employment.income_history.forEach(record => {
                        const amount = record.amount !== null && record.amount !== undefined ? record.amount : 'N/A';
                        const currency = record.currency || '';
                        const unit = record.unit || 'unit';
                        const effectiveDate = record.effective_date || 'N/A';
                        
                        html += `
                            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #f97316;">
                                <div style="font-weight: 500; color: #1e293b;">${amount} ${currency} per ${unit}</div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Effective: ${effectiveDate}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function createInfoItem(label, value) {
            let displayValue;
            
            if (value !== null && value !== undefined && value !== '') {
                // Check if this is a date field and format accordingly
                if (label.toLowerCase().includes('date') || label === 'Date of Birth') {
                    displayValue = formatDate(value);
                } else {
                    displayValue = value;
                }
                
                // Add copy button for ID fields
                if (label.toLowerCase().includes('id') && !displayValue.includes('unavailable')) {
                    displayValue = `<span class="copy-id-container">${displayValue}${createCopyButton(value, `Copy ${label}`)}</span>`;
                }
            } else {
                displayValue = '<span class="unavailable">-</span>';
            }
            
            return `
                <div class="info-item">
                    <div class="info-label">${label}</div>
                    <div class="info-value">${displayValue}</div>
                </div>
            `;
        }

        function renderPaymentsTab(paymentData) {
            if (paymentData.error) {
                return `
                    <div class="drawer-error">
                        <div class="drawer-error-icon">!</div>
                        <div>
                            <strong>Error:</strong> ${paymentData.error}
                        </div>
                    </div>
                `;
            }

            let html = '<div class="info-cards">';

            // Payment Summary Card
            let formattedDateRange = 'N/A';
            if (paymentData.date_range) {
                // Parse the date range "YYYY-MM-DD to YYYY-MM-DD"
                const dateRangeParts = paymentData.date_range.split(' to ');
                if (dateRangeParts.length === 2) {
                    const startDate = formatDate(dateRangeParts[0]);
                    const endDate = formatDate(dateRangeParts[1]);
                    formattedDateRange = `${startDate} to ${endDate}`;
                } else {
                    formattedDateRange = paymentData.date_range;
                }
            }

            html += `
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon employment">💰</div>
                        <h3 class="info-card-title">Payment Summary</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Total Payments</div>
                            <div class="info-value">${paymentData.total_payments || 0}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Date Range</div>
                            <div class="info-value">${formattedDateRange}</div>
                        </div>
                    </div>
                </div>
            `;

            // Individual Payments
            if (paymentData.payments && paymentData.payments.length > 0) {
                paymentData.payments.forEach((payment, index) => {
                    html += `
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon personal">📄</div>
                                <h3 class="info-card-title">${formatDate(payment.pay_date) || 'Date N/A'}</h3>
                            </div>
                    `;

                    // Payment Period Info
                    if (payment.pay_period) {
                        html += `
                            <div class="info-grid" style="margin-bottom: 16px;">
                                <div class="info-item">
                                    <div class="info-label">Pay Period Start</div>
                                    <div class="info-value">${formatDate(payment.pay_period.start_date) || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Pay Period End</div>
                                    <div class="info-value">${formatDate(payment.pay_period.end_date) || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Payment ID</div>
                                    <div class="info-value" style="font-family: monospace; font-size: 12px;"><span class="copy-id-container">${payment.payment_id}${createCopyButton(payment.payment_id, 'Copy Payment ID')}</span></div>
                                </div>
                            </div>
                        `;
                    }

                    // Pay Statement Details
                    if (payment.pay_statement_error) {
                        html += `
                            <div class="drawer-error" style="margin: 16px 0;">
                                <div class="drawer-error-icon">!</div>
                                <div>${payment.pay_statement_error}</div>
                            </div>
                        `;
                    } else if (payment.pay_statement) {
                        const stmt = payment.pay_statement;
                        
                        // Basic pay info
                        html += `
                            <div class="info-grid" style="margin-bottom: 16px;">
                                <div class="info-item">
                                    <div class="info-label">Gross Pay</div>
                                    <div class="info-value">${formatCurrency(stmt.gross_pay)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Net Pay</div>
                                    <div class="info-value">${formatCurrency(stmt.net_pay)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Total Hours</div>
                                    <div class="info-value">${stmt.total_hours || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Payment Method</div>
                                    <div class="info-value">${stmt.payment_method || 'N/A'}</div>
                                </div>
                            </div>
                        `;

                        // Earnings breakdown
                        if (stmt.earnings && stmt.earnings.length > 0) {
                            html += `
                                <div style="margin-bottom: 16px;">
                                    <div class="info-label">Earnings Breakdown</div>
                                    <div style="margin-top: 8px;">
                            `;
                            
                            stmt.earnings.forEach(earning => {
                                html += `
                                    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #0ea5e9;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500; color: #1e293b;">${earning.name || 'Unnamed'}</div>
                                                <div style="font-size: 12px; color: #64748b;">${earning.type || 'N/A'}</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-weight: 600; color: #1e293b;">${formatCurrency(earning)}</div>
                                                ${earning.hours ? `<div style="font-size: 12px; color: #64748b;">${earning.hours} hours</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += '</div></div>';
                        }

                        // Taxes
                        if (stmt.taxes && stmt.taxes.length > 0) {
                            html += `
                                <div style="margin-bottom: 16px;">
                                    <div class="info-label">Taxes</div>
                                    <div style="margin-top: 8px;">
                            `;
                            
                            stmt.taxes.forEach(tax => {
                                const taxType = tax.employer ? 'Employer' : 'Employee';
                                html += `
                                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #f59e0b;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500; color: #1e293b;">${tax.name || 'Unnamed Tax'}</div>
                                                <div style="font-size: 12px; color: #64748b;">${tax.type || 'N/A'} (${taxType})</div>
                                            </div>
                                            <div style="font-weight: 600; color: #1e293b;">${formatCurrency(tax)}</div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += '</div></div>';
                        }

                        // Employee Deductions
                        if (stmt.employee_deductions && stmt.employee_deductions.length > 0) {
                            html += `
                                <div style="margin-bottom: 16px;">
                                    <div class="info-label">Employee Deductions</div>
                                    <div style="margin-top: 8px;">
                            `;
                            
                            stmt.employee_deductions.forEach(deduction => {
                                const taxStatus = deduction.pre_tax ? 'Pre-tax' : 'Post-tax';
                                html += `
                                    <div style="background: #fce7f3; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #ec4899;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500; color: #1e293b;">${deduction.name || 'Unnamed Deduction'}</div>
                                                <div style="font-size: 12px; color: #64748b;">${deduction.type || 'N/A'} (${taxStatus})</div>
                                            </div>
                                            <div style="font-weight: 600; color: #1e293b;">${formatCurrency(deduction)}</div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += '</div></div>';
                        }

                        // Employer Contributions
                        if (stmt.employer_contributions && stmt.employer_contributions.length > 0) {
                            html += `
                                <div style="margin-bottom: 16px;">
                                    <div class="info-label">Employer Contributions</div>
                                    <div style="margin-top: 8px;">
                            `;
                            
                            stmt.employer_contributions.forEach(contribution => {
                                html += `
                                    <div style="background: #dcfce7; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #22c55e;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500; color: #1e293b;">${contribution.name || 'Unnamed Contribution'}</div>
                                                <div style="font-size: 12px; color: #64748b;">${contribution.type || 'N/A'}</div>
                                            </div>
                                            <div style="font-weight: 600; color: #1e293b;">${formatCurrency(contribution)}</div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += '</div></div>';
                        }
                    }

                    html += '</div>';
                });
            } else {
                html += `
                    <div class="info-card">
                        <div class="empty-state" style="padding: 40px 20px;">
                            <h3>No Payment Data</h3>
                            <p>No payment records found for this employee in the selected date range.</p>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function formatCurrency(moneyObject) {
            if (!moneyObject || (!moneyObject.amount && moneyObject.amount !== 0)) {
                return 'N/A';
            }
            
            const amount = moneyObject.amount;
            const currency = moneyObject.currency || 'USD';
            
            // Convert cents to dollars for display (assuming amount is in cents)
            const dollars = amount / 100;
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency.toUpperCase()
            }).format(dollars);
        }


        // Date formatting function
        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A' || dateString === null || dateString === undefined) {
                return 'N/A';
            }
            
            try {
                const date = new Date(dateString);
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return dateString; // Return original if invalid
                }
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString; // Return original if error
            }
        }

        // Copy to clipboard functionality
        function copyToClipboard(text, button) {
            if (!text || text === 'N/A' || text === 'Unknown') {
                return;
            }

            // Use modern Clipboard API if available
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyFeedback(button);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopyTextToClipboard(text, button);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(text, button);
            }
        }

        function fallbackCopyTextToClipboard(text, button) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback(button);
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }

        function showCopyFeedback(button) {
            // Update button appearance
            const originalContent = button.innerHTML;
            button.innerHTML = '✓';
            button.classList.add('copied');

            // Show global feedback
            showGlobalCopyFeedback();

            // Reset button after delay
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.classList.remove('copied');
            }, 1500);
        }

        function showGlobalCopyFeedback() {
            // Remove existing feedback if any
            const existingFeedback = document.querySelector('.copy-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }

            // Create and show new feedback
            const feedback = document.createElement('div');
            feedback.className = 'copy-feedback';
            feedback.textContent = 'ID copied to clipboard!';
            document.body.appendChild(feedback);

            // Trigger animation
            setTimeout(() => {
                feedback.classList.add('show');
            }, 10);

            // Remove after delay
            setTimeout(() => {
                feedback.classList.remove('show');
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 300);
            }, 2000);
        }

        function createCopyButton(text, label = 'Copy ID') {
            if (!text || text === 'N/A' || text === 'Unknown' || text.includes('unavailable')) {
                return '';
            }

            return `<button class="copy-button" onclick="copyToClipboard('${text}', this)" title="${label}" aria-label="${label}">📋</button>`;
        }

        // Close drawer on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEmployeeDrawer();
            }
        });

        // Prevent drawer from closing when clicking inside the drawer
        document.getElementById('employeeDrawer').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Main tab functionality
        let currentMainTab = 'employees';
        let deductionsData = null;

        // Initialize main tabs
        document.addEventListener('DOMContentLoaded', function() {
            const mainTabs = document.querySelectorAll('.tabs .tab');
            mainTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchMainTab(tabName);
                });
            });
        });

        function switchMainTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tabs .tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Show/hide content
            const employeesContent = document.getElementById('employeesTabContent');
            const deductionsContent = document.getElementById('deductionsTabContent');
            
            if (tabName === 'employees') {
                employeesContent.style.display = 'block';
                deductionsContent.style.display = 'none';
                
                // Update search placeholder
                document.getElementById('searchInput').placeholder = 'Search by name, department, or employee ID...';
                document.getElementById('searchInput').style.display = 'block';
            } else if (tabName === 'deductions') {
                employeesContent.style.display = 'none';
                deductionsContent.style.display = 'block';
                
                // Hide search for deductions (we'll add deduction-specific search later)
                document.getElementById('searchInput').style.display = 'none';
                
                // Load deductions data if not already loaded
                if (!deductionsData) {
                    loadDeductionsData();
                }
            }
            
            currentMainTab = tabName;
        }

        function loadDeductionsData() {
            const deductionsContent = document.getElementById('deductionsTabContent');
            
            // Show loading state
            deductionsContent.innerHTML = `
                <div class="deductions-loading">
                    <div class="loading"></div>
                    <p>Loading deductions data...</p>
                </div>
            `;
            
            // Fetch deductions data
            fetch('/api/deductions')
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    
                    if (!response.ok) {
                        // Handle non-200 responses by parsing the JSON error
                        return response.json().then(errorData => {
                            console.log('Error data from server:', errorData);
                            throw { status: response.status, data: errorData };
                        }).catch(jsonError => {
                            console.log('Failed to parse JSON error:', jsonError);
                            // If JSON parsing fails, still try to handle as structured error if we have the response
                            throw { status: response.status, data: null, originalError: jsonError };
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    deductionsData = data;
                    renderDeductionsContent(data);
                })
                .catch(error => {
                    console.error('Error fetching deductions data:', error);
                    console.log('Error object:', error);
                    
                    // Check if this is a structured error with status and data
                    if (error.status && error.data) {
                        console.log('Handling structured error:', error.data);
                        handleDeductionsError(error.data);
                    } else if (error.status === 403) {
                        // Handle 403 without parsed data - try to show reauth prompt anyway
                        console.log('Handling 403 without parsed data');
                        
                        // Try to get connection ID from the current active connection
                        fetch('/api/active-connection')
                            .then(response => response.json())
                            .then(connData => {
                                const connectionId = connData.connection_id || 'unknown';
                                handleDeductionsError({
                                    error_type: 'insufficient_scope',
                                    missing_scopes: ['benefits'],
                                    reauth_url: `/reauth/${connectionId}`,
                                    message: 'Additional permissions needed: benefits'
                                });
                            })
                            .catch(() => {
                                // Fallback if we can't get connection ID
                                handleDeductionsError({
                                    error_type: 'insufficient_scope',
                                    missing_scopes: ['benefits'],
                                    reauth_url: null,
                                    message: 'Additional permissions needed: benefits'
                                });
                            });
                    } else {
                        console.log('Handling generic error');
                        // Generic error handling
                        const deductionsContent = document.getElementById('deductionsTabContent');
                        deductionsContent.innerHTML = `
                            <div class="error-message">
                                <strong>Error:</strong> ${error.message || 'Failed to fetch deductions data'}
                            </div>
                        `;
                    }
                });
        }

        function renderDeductionsContent(data) {
            const deductionsContent = document.getElementById('deductionsTabContent');
            
            if (data.error) {
                deductionsContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${data.error}
                    </div>
                `;
                return;
            }

            let html = '';

            // Summary section
            html += `
                <div class="deductions-summary">
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="summary-stat-number">${data.total_benefits || 0}</span>
                            <span class="summary-stat-label">Total Benefits</span>
                        </div>
                    </div>
                </div>
            `;

            // Search section
            html += `
                <div class="deductions-search">
                    <div style="position: relative;">
                        <span class="deductions-search-icon">🔍</span>
                        <input type="text" class="deductions-search-input" placeholder="Search benefits by type or description..." id="deductionsSearchInput">
                    </div>
                </div>
            `;

            if (data.benefits && data.benefits.length > 0) {
                html += '<div class="deductions-grid">';
                
                data.benefits.forEach(benefit => {
                    html += renderBenefitCard(benefit);
                });
                
                html += '</div>';
            } else {
                html += `
                    <div class="empty-state">
                        <h3>No Benefits Found</h3>
                        <p>No company benefits or deductions are available at this time.</p>
                    </div>
                `;
            }

            deductionsContent.innerHTML = html;

            // Add search functionality for deductions
            const searchInput = document.getElementById('deductionsSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const cards = document.querySelectorAll('.benefit-card');
                    
                    cards.forEach(card => {
                        const type = card.getAttribute('data-type') || '';
                        const description = card.getAttribute('data-description') || '';
                        const isVisible = type.includes(searchTerm) || description.includes(searchTerm);
                        card.style.display = isVisible ? '' : 'none';
                    });
                });
            }
        }

        function renderBenefitCard(benefit) {
            const benefitType = benefit.type || 'unknown';
            const iconClass = getBenefitIconClass(benefitType);
            const frequencyClass = getFrequencyClass(benefit.frequency);
            
            let html = `
                <div class="benefit-card" data-type="${benefitType.toLowerCase()}" data-description="${(benefit.description || '').toLowerCase()}">
                    <div class="benefit-header">
                        <div class="benefit-icon ${iconClass}">
                            ${getBenefitIcon(benefitType)}
                        </div>
                        <div>
                            <h3 class="benefit-title">${formatBenefitType(benefitType)}</h3>
                            <span class="benefit-type">${benefitType}</span>
                        </div>
                    </div>
            `;

            if (benefit.description) {
                html += `<div class="benefit-description">${benefit.description}</div>`;
            }

            html += '<div class="benefit-details">';

            // Benefit ID
            html += `
                <div class="benefit-detail-item">
                    <span class="benefit-detail-label">Benefit ID</span>
                    <span class="benefit-detail-value copy-id-container" style="font-family: monospace; font-size: 12px;">
                        ${benefit.benefit_id}${createCopyButton(benefit.benefit_id, 'Copy Benefit ID')}
                    </span>
                </div>
            `;

            // Frequency
            if (benefit.frequency) {
                html += `
                    <div class="benefit-detail-item">
                        <span class="benefit-detail-label">Frequency</span>
                        <span class="benefit-detail-value">
                            <span class="frequency-badge ${frequencyClass}">${formatFrequency(benefit.frequency)}</span>
                        </span>
                    </div>
                `;
            }

            html += '</div>';

            // Company contribution
            if (benefit.company_contribution) {
                html += renderCompanyContribution(benefit.company_contribution);
            }

            html += '</div>';
            return html;
        }

        function getBenefitIconClass(type) {
            const retirementTypes = ['401k', '401k_roth', '403b', '403b_roth', '457', '457_roth', 'simple', 'simple_ira'];
            const healthTypes = ['fsa_dependent_care', 'fsa_medical', 'hsa_post', 'hsa_pre', 's125_dental', 's125_medical', 's125_vision'];
            const commuterTypes = ['commuter'];
            const customTypes = ['custom_post_tax', 'custom_pre_tax'];

            if (retirementTypes.includes(type)) return 'retirement';
            if (healthTypes.includes(type)) return 'health';
            if (commuterTypes.includes(type)) return 'commuter';
            if (customTypes.includes(type)) return 'custom';
            return 'default';
        }

        function getBenefitIcon(type) {
            const retirementTypes = ['401k', '401k_roth', '403b', '403b_roth', '457', '457_roth', 'simple', 'simple_ira'];
            const healthTypes = ['fsa_dependent_care', 'fsa_medical', 'hsa_post', 'hsa_pre', 's125_dental', 's125_medical', 's125_vision'];
            const commuterTypes = ['commuter'];

            if (retirementTypes.includes(type)) return '🏦';
            if (healthTypes.includes(type)) return '🏥';
            if (commuterTypes.includes(type)) return '🚗';
            return '💼';
        }

        function formatBenefitType(type) {
            const typeMap = {
                '401k': '401(k) Plan',
                '401k_roth': '401(k) Roth Plan',
                '401k_loan': '401(k) Loan',
                '403b': '403(b) Plan',
                '403b_roth': '403(b) Roth Plan',
                '457': '457 Plan',
                '457_roth': '457 Roth Plan',
                'commuter': 'Commuter Benefits',
                'custom_post_tax': 'Custom Post-Tax',
                'custom_pre_tax': 'Custom Pre-Tax',
                'fsa_dependent_care': 'FSA Dependent Care',
                'fsa_medical': 'FSA Medical',
                'hsa_post': 'HSA Post-Tax',
                'hsa_pre': 'HSA Pre-Tax',
                's125_dental': 'Section 125 Dental',
                's125_medical': 'Section 125 Medical',
                's125_vision': 'Section 125 Vision',
                'simple': 'SIMPLE Plan',
                'simple_ira': 'SIMPLE IRA'
            };

            return typeMap[type] || type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getFrequencyClass(frequency) {
            const classMap = {
                'every_paycheck': 'frequency-every-paycheck',
                'monthly': 'frequency-monthly',
                'one_time': 'frequency-one-time'
            };
            return classMap[frequency] || '';
        }

        function formatFrequency(frequency) {
            const frequencyMap = {
                'every_paycheck': 'Every Paycheck',
                'monthly': 'Monthly',
                'one_time': 'One Time'
            };
            return frequencyMap[frequency] || frequency.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function renderCompanyContribution(contribution) {
            if (!contribution) return '';

            let html = '<div class="company-contribution">';
            html += '<div class="contribution-header">Company Contribution</div>';

            if (contribution.type) {
                html += `<div style="margin-bottom: 8px; font-size: 13px; color: #495057;"><strong>Type:</strong> ${contribution.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>`;
            }

            if (contribution.tiers && contribution.tiers.length > 0) {
                html += '<div style="margin-top: 8px;">';
                contribution.tiers.forEach(tier => {
                    html += '<div class="contribution-tier">';
                    html += `<span class="tier-threshold">Threshold: $${formatNumber(tier.threshold || 0)}</span>`;
                    html += `<span class="tier-match">Match: $${formatNumber(tier.match || 0)}</span>`;
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function formatNumber(num) {
            if (typeof num !== 'number') return '0';
            return new Intl.NumberFormat('en-US').format(num);
        }

        function handleDeductionsError(errorData) {
            const deductionsContent = document.getElementById('deductionsTabContent');
            
            // Check if this is an insufficient scope error
            if (errorData.error_type === 'insufficient_scope') {
                const missingScopes = errorData.missing_scopes || [];
                const reauthUrl = errorData.reauth_url;
                const scopeText = missingScopes.length > 0 ? missingScopes.join(', ') : 'additional permissions';
                
                deductionsContent.innerHTML = `
                    <div style="padding: 60px 24px; text-align: center; background: white;">
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                                🔒
                            </div>
                            <h3 style="font-size: 24px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;">
                                Additional Permissions Needed
                            </h3>
                            <p style="font-size: 16px; color: #6c757d; margin-bottom: 8px; line-height: 1.5;">
                                To view company benefits and deductions, we need access to <strong>${scopeText}</strong> data.
                            </p>
                            <p style="font-size: 14px; color: #6c757d; margin-bottom: 32px;">
                                This will only take a moment and won't affect your existing connection.
                            </p>
                            ${reauthUrl ? `
                                <a href="${reauthUrl}" style="display: inline-block; padding: 14px 28px; background: linear-gradient(135deg, #28a745, #20c997); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                    🔓 Add Benefits Access
                                </a>
                            ` : `
                                <a href="/" style="display: inline-block; padding: 14px 28px; background: linear-gradient(135deg, #6c757d, #5a6268); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; transition: all 0.2s ease;">
                                    ← Back to Provider Selection
                                </a>
                            `}
                            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e9ecef;">
                                <p style="font-size: 12px; color: #6c757d; margin: 0;">
                                    <strong>Secure:</strong> Your data is protected and we only request the minimum permissions needed.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Generic error handling for other types of errors
                deductionsContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${errorData.message || errorData.error || 'Failed to load deductions data'}
                    </div>
                `;
            }
        }

    </script>
</body>
</html>
