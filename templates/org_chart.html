<!-- Define macros first -->
{% set department_mapping = {
    'Engineering': 'dept-engineering',
    'Sales': 'dept-sales', 
    'Marketing': 'dept-marketing',
    'HR': 'dept-hr',
    'Human Resources': 'dept-hr',
    'Finance': 'dept-finance',
    'Operations': 'dept-operations',
    'Unknown': 'dept-unknown'
} %}

{% macro get_department_class(department) %}
    {%- for dept, class in department_mapping.items() -%}
        {%- if department and dept.lower() in department.lower() -%}
            {{ class }}
        {%- endif -%}
    {%- endfor -%}
    {%- if not department or department == 'Unknown' -%}
        dept-unknown
    {%- endif -%}
{% endmacro %}

{% macro render_employee(employee) %}
    {% set dept_class = get_department_class(employee.department) %}
    <div class="employee-card {{ dept_class }} {{ 'inactive' if not employee.is_active }}" 
         data-employee-id="{{ employee.id }}">
        <div class="employee-name">{{ employee.first_name }} {{ employee.last_name }}</div>
        <div class="employee-title">{{ employee.title or 'Unknown Title' }}</div>
        <div class="employee-department">{{ employee.department }}</div>
    </div>
    
    {% if employee.children %}
        <div class="children-container">
            <div class="children-row">
                {% for child in employee.children %}
                    <div class="org-tree">
                        {{ render_employee(child) }}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart</title>
    <style>
        body { 
            font-family: sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav-buttons {
            margin-bottom: 20px;
        }
        
        .nav-button {
            display: inline-block;
            padding: 8px 15px;
            margin-right: 10px;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .nav-back { background-color: #6c757d; }
        .nav-company { background-color: #007bff; }
        .nav-directory { background-color: #28a745; }
        
        .nav-button:hover {
            opacity: 0.8;
        }
        
        .unavailable {
            color: red;
            font-style: italic;
            text-align: center;
            margin: 40px 0;
        }
        
        /* Org Chart Styles */
        .org-chart {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .org-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .employee-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
            min-width: 200px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .employee-card.inactive {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            opacity: 0.7;
        }
        
        .employee-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .employee-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .employee-department {
            font-size: 12px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .children-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .children-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        /* Connection Lines */
        .employee-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            width: 2px;
            height: 20px;
            background: #ddd;
            transform: translateX(-50%);
        }
        
        .org-tree > .employee-card::before {
            display: none; /* Hide line for root employees */
        }
        
        .children-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            width: 2px;
            height: 10px;
            background: #ddd;
            transform: translateX(-50%);
        }
        
        /* Department color coding */
        .dept-engineering { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dept-sales { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .dept-marketing { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .dept-hr { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .dept-finance { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .dept-operations { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .dept-unknown { background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%); }
        
        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .legend-item {
            display: inline-block;
            margin: 5px 10px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .children-row {
                flex-direction: column;
                align-items: center;
            }
            
            .employee-card {
                min-width: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-buttons">
            <a href="/" class="nav-button nav-back">‚Üê Back to Provider Selection</a>
            <a href="/company" class="nav-button nav-company">Company Info</a>
            <a href="/directory" class="nav-button nav-directory">Employee Directory</a>
        </div>
        
        <h1>Organization Chart</h1>
        
        {% if error_message %}
            <p class="unavailable">{{ error_message }}</p>
        {% elif org_chart_data %}
            <div class="org-chart">
                <div class="org-tree">
                    {% for root_employee in org_chart_data %}
                        {{ render_employee(root_employee) }}
                    {% endfor %}
                </div>
            </div>
            
            <div class="legend">
                <h3>Department Legend</h3>
                <span class="legend-item dept-engineering">Engineering</span>
                <span class="legend-item dept-sales">Sales</span>
                <span class="legend-item dept-marketing">Marketing</span>
                <span class="legend-item dept-hr">HR</span>
                <span class="legend-item dept-finance">Finance</span>
                <span class="legend-item dept-operations">Operations</span>
                <span class="legend-item dept-unknown">Unknown</span>
            </div>
        {% else %}
            <p class="unavailable">No organizational data available.</p>
        {% endif %}
    </div>
    
    <script>
        // Add click functionality to employee cards
        document.querySelectorAll('.employee-card').forEach(card => {
            card.addEventListener('click', function() {
                const employeeId = this.dataset.employeeId;
                if (employeeId) {
                    window.location.href = `/directory/employee/${employeeId}`;
                }
            });
        });
    </script>
</body>
</html>
